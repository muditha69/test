<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XXX Git - Adult Video Streaming</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --neon-pink: #ff26b2;
            --neon-purple: #b026ff;
            --dark-bg: #0f0c1d;
            --darker-bg: #0a0815;
            --card-bg: #1a1629;
            --text: #ffffff;
            --text-secondary: #b0b3c5;
            --warning: #ff5722;
        }

        body {
            background: linear-gradient(135deg, var(--darker-bg), var(--dark-bg));
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Age Gate */
        .age-gate {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex; /* Ensure it's flex by default for the gate */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 2rem;
        }

        .age-gate-content {
            background: var(--darker-bg);
            border-radius: 15px;
            padding: 3rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 0 40px rgba(176, 38, 255, 0.5);
            border: 2px solid var(--neon-purple);
        }

        .age-gate h1 {
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            color: var(--neon-pink);
            text-shadow: 0 0 15px rgba(255, 38, 178, 0.7);
        }

        .age-gate p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .age-buttons {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .age-btn {
            padding: 1rem 2.5rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        .enter-btn {
            background: linear-gradient(45deg, var(--neon-pink), var(--neon-purple));
            color: white;
        }

        .exit-btn {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--text-secondary);
        }

        .enter-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(255, 38, 178, 0.6);
        }

        .exit-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Header Styles */
        header {
            background: rgba(10, 8, 21, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.2rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(176, 38, 255, 0.2);
        }

        .logo {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--text);
            text-decoration: none;
            text-shadow: 
                0 0 10px var(--neon-pink),
                0 0 20px var(--neon-pink),
                0 0 30px rgba(176, 38, 255, 0.7);
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo i {
            color: var(--neon-pink);
        }

        .warning-badge {
            background-color: var(--warning);
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
            vertical-align: super;
        }

        .header-right {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            margin-left: auto;
        }

        .search-btn {
            background: transparent;
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 1.4rem;
            transition: all 0.3s;
        }

        .search-btn:hover {
            color: var(--neon-pink);
            transform: scale(1.1);
        }

        .profile-container {
            position: relative;
        }

        .profile-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--neon-pink), var(--neon-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }

        .profile-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--neon-pink);
        }

        .profile-btn img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            display: none;
        }

        .dropdown {
            position: absolute;
            top: 55px;
            right: 0;
            background: var(--card-bg);
            border-radius: 8px;
            width: 220px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
            z-index: 10;
            border: 1px solid rgba(176, 38, 255, 0.3);
        }

        .dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.95rem;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(176, 38, 255, 0.1);
        }

        .dropdown-item i {
            width: 24px;
            text-align: center;
            color: var(--neon-pink);
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            padding: 1.5rem 5%;
            background: rgba(10, 8, 21, 0.7);
            border-bottom: 1px solid rgba(176, 38, 255, 0.1);
        }

        .tab {
            padding: 0.8rem 2rem;
            margin: 0 0.5rem;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .tab.active, .tab:hover {
            color: var(--text);
            background: rgba(176, 38, 255, 0.15);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: var(--neon-pink);
            border-radius: 10px;
            box-shadow: 0 0 10px var(--neon-pink);
        }

        /* Categories Grid */
        .categories-section {
            padding: 3rem 5%;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, var(--neon-pink), transparent);
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .category-card {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            border: 1px solid rgba(176, 38, 255, 0.1);
            cursor: pointer;
            height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4), 0 0 0 2px var(--neon-pink);
        }

        .category-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .category-card:hover .category-image {
            opacity: 0.9;
        }

        .category-name {
            position: relative;
            padding: 1rem;
            font-weight: 600;
            font-size: 1.2rem;
            z-index: 2;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        }

        /* Video Grid */
        .video-section {
            padding: 3rem 5%;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
        }

        .video-card {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            border: 1px solid rgba(176, 38, 255, 0.1);
            cursor: pointer;
        }

        .video-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4), 0 0 0 2px var(--neon-pink);
        }

        .video-thumb {
            height: 180px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .video-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }

        .video-card:hover .video-thumb img {
            transform: scale(1.1);
        }

        .video-duration {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            z-index: 2;
        }

        .play-btn { /* This will now be a visual indicator, not directly clickable for play */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: rgba(255, 38, 178, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 2;
            pointer-events: none; /* Make it non-interactive */
        }

        .video-card:hover .play-btn {
            opacity: 1;
        }

        .play-btn i {
            color: white;
            font-size: 1.2rem;
        }

        .video-info {
            padding: 1.2rem;
        }

        .video-info h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 3.2rem;
            line-height: 1.4;
        }

        .video-meta {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .video-views {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .video-likes {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: var(--neon-pink);
        }

        /* Footer */
        footer {
            background: var(--darker-bg);
            padding: 2rem 5%;
            text-align: center;
            margin-top: 3rem;
            border-top: 1px solid rgba(176, 38, 255, 0.1);
        }

        .footer-logo {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text);
            text-shadow: 
                0 0 10px var(--neon-pink),
                0 0 20px var(--neon-pink);
        }

        .copyright {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
        }

        .disclaimer {
            background: rgba(255, 87, 34, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1.5rem;
            font-size: 0.85rem;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .video-grid, .categories-grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .logo {
                font-size: 1.8rem;
            }
            
            header {
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .tabs {
                overflow-x: auto;
                justify-content: flex-start;
                padding: 1rem 5%;
            }
            
            .tab {
                padding: 0.7rem 1.5rem;
                font-size: 1rem;
                flex-shrink: 0;
            }
            
            .video-grid, .categories-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 1.5rem;
            }
            
            .video-thumb {
                height: 150px;
            }
        }

        @media (max-width: 576px) {
            .logo {
                font-size: 1.5rem;
            }
            
            .header-right {
                gap: 1rem;
            }
            
            .video-grid, .categories-grid {
                grid-template-columns: 1fr;
            }
            
            .section-title {
                font-size: 1.5rem;
            }
            
            .age-gate-content {
                padding: 2rem 1.5rem;
            }
            
            .age-buttons {
                flex-direction: column;
                gap: 1rem;
            }
            
            .age-btn {
                width: 100%;
            }
        }

        /* Custom Message Box and Prompt Styles */
        .custom-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .custom-box {
            background-color: var(--card-bg);
            color: var(--text);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--neon-pink);
            width: 90%;
            max-width: 400px;
        }

        .custom-box p {
            text-align: center;
            font-size: 1.1rem;
        }

        .custom-box button {
            background-color: var(--neon-pink);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }

        .custom-box button:hover {
            background-color: #d81b60;
        }

        .custom-prompt-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .custom-prompt-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: 5px;
        }

        .custom-prompt-buttons .no-btn {
            background-color: #555;
        }

        .custom-prompt-buttons .no-btn:hover {
            background-color: #777;
        }
    </style>
</head>
<body>
    <!-- Age Verification Gate -->
    <div class="age-gate" id="age-gate">
        <div class="age-gate-content">
            <h1><i class="fas fa-exclamation-triangle"></i> ADULTS ONLY</h1>
            <p>This website contains explicit adult material intended for individuals 18 years of age or older.</p>
            <p>By entering this site, you certify that you are at least 18 years old and that you want to view sexually explicit material for your own personal enjoyment.</p>
            <div class="age-buttons">
                <button class="age-btn enter-btn" id="enter-btn">Enter Site</button>
                <button class="age-btn exit-btn" id="exit-btn">Exit</button>
            </div>
            <p class="disclaimer">XXX Git is a video aggregator that embeds content from external sources. We do not host any videos on our servers.</p>
        </div>
    </div>

    <header>
        <div class="logo">
            <i class="fas fa-fire"></i> <a href = "admin.html">XXX Git</a>
            <span class="warning-badge">18+</span>
        </div>
        <div class="header-right">
            <button class="search-btn">
                <i class="fas fa-search"></i>
            </button>
            <div class="profile-container">
                <div class="profile-btn" id="profile-btn">
                    <i class="fas fa-user" id="profile-icon"></i>
                </div>
                <div class="dropdown">
                    <!-- User Name/ID Display -->
                    <div class="dropdown-item" id="user-display-info" style="display: none;">
                        <i class="fas fa-user-circle"></i>
                        <span id="current-user-name"></span>
                    </div>
                    <div class="dropdown-item" id="google-login">
                        <i class="fab fa-google"></i>
                        <span>Log in with Google</span>
                    </div>
                    <div class="dropdown-item" id="guest-login">
                        <i class="fas fa-user-clock"></i>
                        <span>Log in with Guest Account</span>
                    </div>
                    <!-- Logout Button -->
                    <div class="dropdown-item" id="logout-button" style="display: none;">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab active" data-tab="home">Home</button>
        <button class="tab" data-tab="categories">Categories</button>
        <button class="tab" data-tab="favourite">Favourite</button>
        <button class="tab" data-tab="premium">Premium</button>
    </div>

    <section class="categories-section" id="categories-content" style="display:none;">
        <h2 class="section-title">Categories</h2>
        <div class="categories-grid">
            <div class="category-card" data-category="amateur">
                <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=600&q=80" alt="Amateur" class="category-image">
                <div class="category-name">Amateur</div>
            </div>
            <div class="category-card" data-category="anal">
                <img src="https://images.unsplash.com/photo-1519699047748-de8e457a634e?auto=format&fit=crop&w=600&q=80" alt="Anal" class="category-image">
                <div class="category-name">Anal</div>
            </div>
            <div class="category-card" data-category="blowjob">
                <img src="https://images.unsplash.com/photo-1589156280159-27698a70f29e?auto=format&fit=crop&w=600&q=80" alt="Blowjob" class="category-image">
                <div class="category-name">Blowjob</div>
            </div>
            <div class="category-card" data-category="cosplay">
                <img src="https://images.unsplash.com/photo-1570612861542-284f4c12e75f?auto=format&fit=crop&w=600&q=80" alt="Cosplay" class="category-image">
                <div class="category-name">Cosplay</div>
            </div>
            <div class="category-card" data-category="creampie">
                <img src="https://images.unsplash.com/photo-1583524505974-6facd53f4592?auto=format&fit=crop&w=600&q=80" alt="Creampie" class="category-image">
                <div class="category-name">Creampie</div>
            </div>
            <div class="category-card" data-category="gangbang">
                <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=600&q=80" alt="Gangbang" class="category-image">
                <div class="category-name">Gangbang</div>
            </div>
            <div class="category-card" data-category="hardcore">
                <img src="https://images.unsplash.com/photo-1567532939604-b6b5b0e16019?auto=format&fit=crop&w=600&q=80" alt="Hardcore" class="category-image">
                <div class="category-name">Hardcore</div>
            </div>
            <div class="category-card" data-category="lesbian">
                <img src="https://images.unsplash.com/photo-1491349174775-aaafddd81942?auto=format&fit=crop&w=600&q=80" alt="Lesbian" class="category-image">
                <div class="category-name">Lesbian</div>
            </div>
        </div>
    </section>

    <section class="video-section" id="home-content">
        <h2 class="section-title">Featured Videos</h2>
        <div class="video-grid" id="public-video-grid">
            <!-- Public videos will be loaded here by JavaScript from Firestore -->
            <div class="placeholder-message" id="loading-public-videos">
                <i class="fas fa-spinner fa-spin" style="font-size: 4rem; color: var(--neon-pink); margin-bottom: 1rem;"></i>
                <h3>Loading Videos...</h3>
                <p>Please wait while we fetch the latest content.</p>
            </div>
        </div>
    </section>

    <section class="video-section" id="favourite-content" style="display:none;">
        <h2 class="section-title">Favourites</h2>
        <div class="video-grid" id="favourite-video-grid">
            <!-- Favourites will be loaded here by JavaScript -->
            <div class="placeholder-message">
                <i class="fas fa-heart-broken" style="font-size: 4rem; color: var(--neon-pink); margin-bottom: 1rem;"></i>
                <h3>No favourites yet</h3>
                <p>Add videos to your favourites to see them here</p>
            </div>
        </div>
    </section>

    <section class="video-section" id="premium-content" style="display:none;">
        <h2 class="section-title">Premium Content</h2>
        <div class="video-grid">
            <div class="placeholder-message">
                <i class="fas fa-crown" style="font-size: 4rem; color: var(--neon-pink); margin-bottom: 1rem;"></i>
                <h3>Premium Membership Required</h3>
                <p>Upgrade to premium to access exclusive content</p>
                <button class="action-btn" style="margin-top: 1.5rem; background: var(--neon-pink);">
                    <i class="fas fa-gem"></i> Upgrade Now
                </button>
            </div>
        </div>
    </section>

    <footer>
        <div class="footer-logo">XXX Git</div>
        <div class="copyright">
            © 2023 XXX Git Video Streaming. All rights reserved.
            <div class="disclaimer">
                <strong>Disclaimer:</strong> XXX Git is an adult content aggregator that embeds videos from external sources. 
                We do not host, produce, or own any of the videos displayed on this site. 
                All videos are the property of their respective owners. This site is intended for adults aged 18 and over.
            </div>
        </div>
    </footer>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, getDocs, query, FieldValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // IMPORTANT: Use the global variables provided by the Canvas environment for Firebase configuration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Authenticate with __initial_auth_token
        let isAuthReady = false; // Flag to indicate if authentication has completed its initial check
        onAuthStateChanged(auth, async (user) => {
            const userDisplayInfo = document.getElementById('user-display-info');
            const currentUserNameSpan = document.getElementById('current-user-name');
            const googleLoginBtn = document.getElementById('google-login');
            const guestLoginBtn = document.getElementById('guest-login');
            const logoutBtn = document.getElementById('logout-button');
            const profileBtnElement = document.getElementById('profile-btn'); // The div
            const profileIconElement = document.getElementById('profile-icon'); // The <i> tag

            if (!isAuthReady) { // Only run initial sign-in logic once
                try {
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with custom token. Current user:", auth.currentUser);
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously. Current user:", auth.currentUser);
                    }
                } catch (error) {
                    console.error("Failed to sign in:", error);
                }
                isAuthReady = true; // Set flag after initial auth attempt
            }

            if (user) {
                // User is signed in.
                console.log("User is signed in:", user.uid);
                console.log("Using appId:", appId); // Log appId for debugging
                
                // Update profile picture
                if (user.photoURL) {
                    profileBtnElement.style.backgroundImage = `url('${user.photoURL}')`;
                    profileIconElement.style.display = 'none'; // Hide the default icon
                } else {
                    profileBtnElement.style.backgroundImage = 'none'; // Remove background image
                    profileIconElement.style.display = 'block'; // Show default icon
                }

                // Update display name and manage login/logout buttons
                if (user.isAnonymous) {
                    currentUserNameSpan.textContent = `Guest User (${user.uid.substring(0, 8)}...)`;
                    googleLoginBtn.style.display = 'flex'; // Allow guest to upgrade to Google
                    guestLoginBtn.style.display = 'none'; // Hide guest login as they are already a guest
                } else {
                    currentUserNameSpan.textContent = user.displayName || user.email;
                    googleLoginBtn.style.display = 'none'; // Hide Google login as they are already logged in
                    guestLoginBtn.style.display = 'none';
                }
                userDisplayInfo.style.display = 'flex'; // Show user info
                logoutBtn.style.display = 'flex'; // Always show logout if any user is signed in
                
                // Fetch public videos and favorites only after authentication is ready
                fetchPublicVideos();
                if (document.querySelector('.tab[data-tab="favourite"]').classList.contains('active')) {
                    fetchUserFavorites(user.uid);
                }
            } else {
                // User is signed out.
                console.log("User is signed out.");

                // Reset profile picture and name
                profileBtnElement.style.backgroundImage = 'none'; // Remove background image
                profileIconElement.style.display = 'block'; // Show default icon
                currentUserNameSpan.textContent = '';
                userDisplayInfo.style.display = 'none'; // Hide user info

                // Show login options, hide logout
                googleLoginBtn.style.display = 'flex';
                guestLoginBtn.style.display = 'flex';
                logoutBtn.style.display = 'none';
                
                // Only display "No favorites" if the favourites tab is active and no user is logged in
                if (document.querySelector('.tab[data-tab="favourite"]').classList.contains('active')) {
                    displayNoFavoritesMessage("Please log in to see your favourites.");
                }
            }
        });


        // Age Gate Functionality
        const ageGate = document.getElementById('age-gate');
        const enterBtn = document.getElementById('enter-btn');
        const exitBtn = document.getElementById('exit-btn');
        
        // Wrap age gate logic in DOMContentLoaded to ensure elements are ready
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user has already verified age
            if(localStorage.getItem('ageVerified')) {
                ageGate.style.display = 'none';
                document.body.style.overflow = 'auto';
            } else {
                ageGate.style.display = 'flex'; // Explicitly set to flex if not verified
                document.body.style.overflow = 'hidden';
            }
            
            enterBtn.addEventListener('click', () => {
                console.log("Enter button clicked!"); // Debugging log
                ageGate.style.display = 'none';
                document.body.style.overflow = 'auto';
                localStorage.setItem('ageVerified', 'true');
            });
            
            exitBtn.addEventListener('click', () => {
                window.location.href = 'https://www.google.com';
            });
        });

        // Profile dropdown functionality
        const profileBtn = document.getElementById('profile-btn');
        const profileIcon = document.getElementById('profile-icon'); // The <i> tag for default icon
        const dropdown = document.querySelector('.dropdown');
        
        profileBtn.addEventListener('click', () => {
            dropdown.classList.toggle('active');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!profileBtn.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });
        
        // Tab switching functionality
        const tabs = document.querySelectorAll('.tab');
        const contents = {
            home: document.getElementById('home-content'),
            categories: document.getElementById('categories-content'),
            favourite: document.getElementById('favourite-content'),
            premium: document.getElementById('premium-content')
        };
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                
                // Hide all content sections
                Object.values(contents).forEach(content => {
                    content.style.display = 'none';
                });
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Show corresponding content
                const tabName = tab.getAttribute('data-tab');
                contents[tabName].style.display = 'block';

                // If the 'Home' tab is selected, refresh public videos
                if (tabName === 'home') {
                    fetchPublicVideos();
                }
                // If the 'Favourite' tab is selected, refresh favorites
                else if (tabName === 'favourite') {
                    const user = auth.currentUser;
                    if (user) {
                        fetchUserFavorites(user.uid);
                    } else {
                        displayNoFavoritesMessage("Please log in to see your favourites.");
                    }
                }
            });
        });
        
        // Login functionality
        document.getElementById('google-login').addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then((result) => {
                    // onAuthStateChanged will handle UI updates
                    console.log("Google Login Successful:", result.user);
                    showCustomMessage(`Logged in as: ${result.user.displayName || result.user.email}`);
                    dropdown.classList.remove('active');
                })
                .catch((error) => {
                    const errorMessage = error.message;
                    console.error("Google Login Error:", errorMessage);
                    showCustomMessage(`Google login failed: ${errorMessage}`);
                });
        });
        
        document.getElementById('guest-login').addEventListener('click', () => {
            signInAnonymously(auth)
                .then(() => {
                    // onAuthStateChanged will handle UI updates
                    console.log("Guest Login Successful:", auth.currentUser);
                    showCustomMessage('Logged in as Guest');
                    dropdown.classList.remove('active');
                })
                .catch((error) => {
                    const errorMessage = error.message;
                    console.error("Guest Login Error:", errorMessage);
                    showCustomMessage(`Guest login failed: ${errorMessage}`);
                });
        });

        // Add logout functionality
        document.getElementById('logout-button').addEventListener('click', () => {
            auth.signOut().then(() => {
                showCustomMessage("Logged out successfully.");
                dropdown.classList.remove('active');
                // onAuthStateChanged will handle UI updates
            }).catch((error) => {
                console.error("Logout Error:", error);
                showCustomMessage("Logout failed. Please try again.");
            });
        });
        
        // Search functionality
        const searchBtn = document.querySelector('.search-btn');
        searchBtn.addEventListener('click', () => {
            showCustomMessage('Search functionality coming soon!');
        });
        
        // Custom UI functions (message box and prompt)
        function showCustomMessage(message) {
            const overlay = document.createElement('div');
            overlay.classList.add('custom-overlay');
            overlay.innerHTML = `
                <div class="custom-box">
                    <p>${message}</p>
                    <button>OK</button>
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(overlay);
            });
        }

        function showCustomPrompt(message, callback) {
            const overlay = document.createElement('div');
            overlay.classList.add('custom-overlay');
            overlay.innerHTML = `
                <div class="custom-box">
                    <p>${message}</p>
                    <div class="custom-prompt-buttons">
                        <button class="yes-btn">Yes</button>
                        <button class="no-btn">No</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            const yesBtn = overlay.querySelector('.yes-btn');
            const noBtn = overlay.querySelector('.no-btn');

            yesBtn.addEventListener('click', () => {
                document.body.removeChild(overlay);
                callback(true);
            });

            noBtn.addEventListener('click', () => {
                document.body.removeChild(overlay);
                callback(false);
            });
        }

        // Helper function to convert string numbers (e.g., "2.4M") to actual numbers
        function parseMetricString(metricString) {
            if (typeof metricString !== 'string') return metricString; // Already a number
            const value = parseFloat(metricString);
            if (metricString.includes('K')) {
                return value * 1000;
            } else if (metricString.includes('M')) {
                return value * 1000000;
            }
            return value;
        }

        // Helper function to format numbers back to "K" or "M" strings
        function formatMetricNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // Function to increment views or likes
        async function incrementVideoMetric(videoId, metricType) {
            try {
                const videoRef = doc(db, "artifacts", appId, "public", "data", "public_videos", videoId);
                await updateDoc(videoRef, {
                    [metricType]: FieldValue.increment(1)
                });
                console.log(`${metricType} incremented for video ${videoId}`);
                // Re-fetch public videos to update the UI
                fetchPublicVideos(); 
            } catch (error) {
                console.error(`Error incrementing ${metricType}:`, error);
                showCustomMessage(`Failed to update ${metricType}.`);
            }
        }

        // Firebase Firestore Functions for Favorites
        async function addVideoToFavorites(videoDetails) {
            const user = auth.currentUser;
            if (!user) {
                showCustomMessage("Please log in to add favorites.");
                return;
            }

            // Reference to the user's favorites subcollection
            // Path: /artifacts/{appId}/users/{userId}/favorites/{videoId_base64encoded}
            const userFavoritesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'favorites');

            // Encode URL to be a valid Firestore document ID (Firestore IDs cannot contain '/', '#', etc.)
            // Using video ID directly if available, otherwise URL
            const docId = videoDetails.id || btoa(videoDetails.url).replace(/=/g, '');

            try {
                await setDoc(doc(userFavoritesRef, docId), {
                    title: videoDetails.title,
                    thumbnail: videoDetails.thumbnail,
                    duration: videoDetails.duration,
                    views: videoDetails.views,
                    likes: videoDetails.likes,
                    url: videoDetails.url, // This will be the direct play URL
                    description: videoDetails.description,
                    timestamp: FieldValue.serverTimestamp() // To record when it was added
                });
                showCustomMessage("Video added to favorites! ❤️");
                console.log("Document successfully written!");
                // If user is on 'Favourite' tab, refresh it.
                if (document.querySelector('.tab[data-tab="favourite"]').classList.contains('active')) {
                    fetchUserFavorites(user.uid);
                }
            } catch (error) {
                console.error("Error writing document: ", error);
                showCustomMessage("Failed to add to favorites. Please try again.");
            }
        }

        // Function to fetch user favorites and display them
        function fetchUserFavorites(userId) {
            const favouriteVideoGrid = document.getElementById('favourite-video-grid');
            favouriteVideoGrid.innerHTML = ''; // Clear existing content

            if (!userId) {
                displayNoFavoritesMessage("Please log in to see your favourites.");
                return;
            }

            const userFavoritesRef = collection(db, 'artifacts', appId, 'users', userId, 'favorites');
            // Firestore does not support orderBy on a field that might not exist for all documents
            // Fetch all and sort in memory if needed.
            getDocs(userFavoritesRef)
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        displayNoFavoritesMessage();
                        return;
                    }

                    let favVideos = [];
                    querySnapshot.forEach((doc) => {
                        favVideos.push({ id: doc.id, ...doc.data() });
                    });

                    // Sort by timestamp in descending order (newest first)
                    favVideos.sort((a, b) => {
                        const dateA = a.timestamp ? a.timestamp.toDate() : new Date(0);
                        const dateB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                        return dateB - dateA;
                    });

                    favVideos.forEach((favVideo) => {
                        const videoCard = createVideoCardElement(favVideo);
                        favouriteVideoGrid.appendChild(videoCard);
                    });
                })
                .catch((error) => {
                    console.error("Error getting favorites: ", error);
                    displayNoFavoritesMessage("Error loading favorites.");
                });
        }

        // Function to fetch public videos and display them
        const publicVideoGrid = document.getElementById('public-video-grid');
        const loadingPublicVideos = document.getElementById('loading-public-videos');

        async function fetchPublicVideos() {
            publicVideoGrid.innerHTML = ''; // Clear existing content
            loadingPublicVideos.style.display = 'flex'; // Show loading indicator

            try {
                const publicVideosRef = collection(db, 'artifacts', appId, 'public', 'data', 'public_videos');
                const querySnapshot = await getDocs(publicVideosRef); 

                loadingPublicVideos.style.display = 'none'; // Hide loading indicator

                if (querySnapshot.empty) {
                    publicVideoGrid.innerHTML = `
                        <div class="placeholder-message">
                            <i class="fas fa-video-slash" style="font-size: 4rem; color: var(--neon-pink); margin-bottom: 1rem;"></i>
                            <h3>No videos available yet</h3>
                            <p>Check back later or add some from the admin panel!</p>
                        </div>
                    `;
                    return;
                }

                let videos = [];
                querySnapshot.forEach((doc) => {
                    videos.push({ id: doc.id, ...doc.data() }); // Include doc.id
                });

                // Sort videos by createdAt in JavaScript after fetching
                videos.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0); // Handle potential missing createdAt
                    const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA; // Descending order (newest first)
                });

                videos.forEach((video) => {
                    const videoCard = createVideoCardElement(video);
                    publicVideoGrid.appendChild(videoCard);
                });

            } catch (error) {
                console.error("Error fetching public videos: ", error);
                loadingPublicVideos.style.display = 'none';
                publicVideoGrid.innerHTML = `
                    <div class="placeholder-message">
                        <i class="fas fa-exclamation-circle" style="font-size: 4rem; color: var(--warning); margin-bottom: 1rem;"></i>
                        <h3>Error loading videos</h3>
                        <p>Please try again later.</p>
                    </div>
                `;
            }
        }

        // Helper function to create a video card element (reused for both public and favorite videos)
        function createVideoCardElement(videoData) {
            const videoCard = document.createElement('div');
            videoCard.classList.add('video-card');
            videoCard.setAttribute('data-video-id', videoData.id); // Store Firestore document ID
            videoCard.setAttribute('data-video-url', videoData.url); 

            // Format views and likes for display
            const displayViews = formatMetricNumber(parseMetricString(videoData.views || "0"));
            const displayLikes = formatMetricNumber(parseMetricString(videoData.likes || "0"));

            videoCard.innerHTML = `
                <div class="video-thumb">
                    <img src="${videoData.thumbnail}" alt="Video Thumbnail" onerror="this.onerror=null; this.src='https://placehold.co/1260x750/0f0c1d/ffffff?text=No+Image'">
                    <div class="video-duration">${videoData.duration}</div>
                    <div class="play-btn">
                        <i class="fas fa-play"></i>
                    </div>
                </div>
                <div class="video-info">
                    <h3>${videoData.title}</h3>
                    <div class="video-meta">
                        <div class="video-views">
                            <i class="fas fa-eye"></i> ${displayViews}
                        </div>
                        <div class="video-likes">
                            <i class="fas fa-heart"></i> ${displayLikes}
                        </div>
                    </div>
                </div>
            `;

            // Event listeners for single and double click
            let clickTimer = null;
            videoCard.addEventListener('click', (event) => {
                // Prevent event from bubbling up to parent if it's a child element click
                if (event.target.closest('.video-card') !== videoCard) {
                    return;
                }

                if (clickTimer === null) {
                    clickTimer = setTimeout(() => {
                        // Single click action: Open video URL and increment views
                        window.open(videoData.url, '_blank'); // Open video URL in new tab
                        incrementVideoMetric(videoData.id, 'views');
                        clickTimer = null;
                    }, 300); // 300ms to differentiate single from double click
                } else {
                    // Double click action: Increment likes and prompt for favorite
                    clearTimeout(clickTimer);
                    clickTimer = null;
                    incrementVideoMetric(videoData.id, 'likes');
                    showCustomPrompt('Do you want to add this video to your favorites?', (response) => {
                        if (response) {
                            addVideoToFavorites(videoData);
                        }
                    });
                }
            });

            return videoCard;
        }

        // Function to display the "No favorites yet" message
        function displayNoFavoritesMessage(message = "No favourites yet") {
            const favouriteVideoGrid = document.getElementById('favourite-video-grid');
            favouriteVideoGrid.innerHTML = `
                <div class="placeholder-message">
                    <i class="fas fa-heart-broken" style="font-size: 4rem; color: var(--neon-pink); margin-bottom: 1rem;"></i>
                    <h3>${message}</h3>
                    <p>Add videos to your favourites to see them here</p>
                </div>
            `;
        }
        
    </script>
</body>
</html>
